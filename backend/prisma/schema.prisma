generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  code        String   @unique
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Settings / metadata
  locale      String?  // e.g. "en-KE"
  currency    String?  // e.g. "KES"
  features    Json?    @db.JsonB

  // Relations
  users               User[]
  unitsOfMeasure      UnitOfMeasure[]
  locations           Location[]
  products            Product[]
  productBatches      ProductBatch[]
  stockQuants         StockQuant[]
  customers           Customer[]
  invoices            Invoice[]
  transactions        Transaction[]
  members             Member[]
  accounts            Account[]
  loans               Loan[]
  sessions            Session[]
  systemLogs          SystemLog[]
  chamaConstitution   ChamaConstitution?
  stockTakes          StockTake[]
  stockTakeItems      StockTakeItem[]
  employees           Employee[]
  passwordResetTokens PasswordResetToken[]
  // New modules
  stockTransfers      StockTransfer[]
  stockTransferItems  StockTransferItem[]
  suppliers            Supplier[]
  purchaseOrders       PurchaseOrder[]
  purchaseOrderItems   PurchaseOrderItem[]
  supplierInvoices     SupplierInvoice[]
  supplierInvoiceItems SupplierInvoiceItem[]
  glAccounts           GLAccount[]
  glJournalEntries     GLJournalEntry[]
  glJournalLines       GLJournalLine[]
  projects             Project[]
  billsOfMaterial      BillOfMaterial[]
  billOfMaterialItems  BillOfMaterialItem[]
  productionOrders     ProductionOrder[]
  assets               Asset[]
  depreciationRuns     DepreciationRun[]
  idempotencyKeys      IdempotencyKey[]
  priceLists           PriceList[]
  priceListItems       PriceListItem[]
  coupons              Coupon[]
  couponRedemptions    CouponRedemption[]
  shifts               Shift[]
}


enum UserRole {
  ADMIN
  MANAGER
  CASHIER
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String
  name         String?
  phone        String?
  tenantId     String   @db.Uuid
  passwordHash String
  role         UserRole
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  systemLogs SystemLog[]
  passwordResetTokens PasswordResetToken[]

  @@index([tenantId])
  @@unique([tenantId, email])
}

model UnitOfMeasure {
  id           String          @id @default(uuid()) @db.Uuid
  name         String
  tenantId     String          @db.Uuid
  baseUnitId   String?         @db.Uuid
  ratio        Decimal
  category     String          // "Length", "Weight", "Unit", etc.

  tenant       Tenant          @relation(fields: [tenantId], references: [id])
  baseUnit     UnitOfMeasure?  @relation("BaseUnit", fields: [baseUnitId], references: [id])
  derivedUnits UnitOfMeasure[] @relation("BaseUnit")

  products             Product[]
  stockQuants          StockQuant[]
  productBatches       ProductBatch[]
  supplierInvoiceItems SupplierInvoiceItem[]

  @@index([tenantId])
  @@index([tenantId, category])
}

model Location {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  code      String
  tenantId  String   @db.Uuid
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant           @relation(fields: [tenantId], references: [id])
  stockQuants          StockQuant[]
  stockTransfersFrom   StockTransfer[]  @relation("FromLocation")
  stockTransfersTo     StockTransfer[]  @relation("ToLocation")
  productionOrders     ProductionOrder[]
  gatePassesFrom       GatePass[]       @relation("GateFromLocation")
  gatePassesTo         GatePass[]       @relation("GateToLocation")

  @@index([tenantId])
  @@unique([tenantId, code])
}

model Product {
  id               String          @id @default(uuid()) @db.Uuid
  tenantId         String          @db.Uuid
  name             String
  sku              String
  description      String?
  defaultUomId     String          @db.Uuid
  category         String?
  defaultPrice     Decimal         @default(0)
  isActive         Boolean         @default(true)
  minStockQuantity Decimal?        @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  tenant           Tenant          @relation(fields: [tenantId], references: [id])
  defaultUom       UnitOfMeasure   @relation(fields: [defaultUomId], references: [id])
  batches          ProductBatch[]
  stockQuants      StockQuant[]
  invoiceItems     InvoiceItem[]
  supplierInvoiceItems SupplierInvoiceItem[]

  @@index([tenantId])
  @@unique([tenantId, sku])
}

model ProductBatch {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @db.Uuid
  productId   String        @db.Uuid
  batchNumber String
  expiryDate  DateTime?
  uomId       String        @db.Uuid
  createdAt   DateTime      @default(now())

  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  product     Product       @relation(fields: [productId], references: [id])
  uom         UnitOfMeasure @relation(fields: [uomId], references: [id])
  stockQuants StockQuant[]

  @@index([tenantId])
  @@unique([tenantId, productId, batchNumber])
}

model StockQuant {
  id         String        @id @default(uuid()) @db.Uuid
  tenantId   String        @db.Uuid
  productId  String        @db.Uuid
  locationId String        @db.Uuid
  batchId    String?       @db.Uuid
  uomId      String        @db.Uuid
  quantity   Decimal       // stored in the given UoM

  tenant     Tenant        @relation(fields: [tenantId], references: [id])
  product    Product       @relation(fields: [productId], references: [id])
  location   Location      @relation(fields: [locationId], references: [id])
  batch      ProductBatch? @relation(fields: [batchId], references: [id])
  uom        UnitOfMeasure @relation(fields: [uomId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, productId, locationId, batchId, uomId])
}

model Customer {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  name        String
  phone       String?
  email       String?
  kraPin      String?  // KRA PIN for compliance (optional)
  loyaltyPoints Decimal @default(0)
  priceListId String?  @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  invoices   
model Invoice {
  id           String        @id @default(uuid()) @db.Uuid
  tenantId     String        @db.Uuid
  customerId   String        @db.Uuid
  projectId    String?       @db.Uuid
  invoiceNo    String
  status       String        // "Draft", "Posted", "Paid", "Partial"
  issueDate    DateTime
  dueDate      DateTime?
  totalAmount  Decimal       @default(0)
  isTraining   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  customer     Customer      @relation(fields: [customerId], references: [id])
  project      Project?      @relation(fields: [projectId], references: [id])
  items        InvoiceItem[]
  transactions Transaction[]
  glJournalEntries GLJournalEntry[]
  couponRedemptions CouponRedemption[]

  @@index([tenantId])
  @@index([tenantId, projectId])
  @@unique([tenantId, invoiceNo])
}

model InvoiceItem {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  invoiceId  String   @db.Uuid
  productId  String   @db.Uuid
  quantity   Decimal
  unitPrice  Decimal
  uomId      String   @db.Uuid
  lineTotal  Decimal  @default(0)
  hsCode     String   // HS code for customs/tax classification
  taxRate    TaxRate  @default(VAT_16)

  tenant     Tenant        @relation(fields: [tenantId], references: [id])
  invoice    Invoice       @relation(fields: [invoiceId], references: [id])
  product    Product       @relation(fields: [productId], references: [id])
  uom        UnitOfMeasure @relation(fields: [uomId], references: [id])

  @@index([tenantId])
}

model Transaction {
  id                String          @id @default(uuid()) @db.Uuid
  tenantId          String          @db.Uuid
  invoiceId         String?         @db.Uuid
  accountId         String?         @db.Uuid
  supplierInvoiceId String?         @db.Uuid
  amount            Decimal
  type              TransactionType
  paymentMethod     PaymentMethod?  // When applicable: CASH, MPESA, CARD, MANUAL, OTHER
  reference         String?
  createdAt         DateTime        @default(now())

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  invoice          Invoice?         @relation(fields: [invoiceId], references: [id])
  account          Account?         @relation(fields: [accountId], references: [id])
  supplierInvoice  SupplierInvoice? @relation(fields: [supplierInvoiceId], references: [id])

  @@index([tenantId])
  @@index([tenantId, supplierInvoiceId])
}

enum AccountType {
  ShareCapital
  Deposits
  MerryGoRound
}

enum TransactionType {
  Debit
  Credit
}

enum PaymentMethod {
  CASH
  MPESA
  CARD
  MANUAL
  OTHER
}

model Member {
  id          String    @id @default(uuid()) @db.Uuid
  tenantId    String    @db.Uuid
  name        String
  phone       String?
  email       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  accounts    Account[]
  loans       Loan[]           @relation("BorrowerLoans")
  guaranteedLoans LoanGuarantor[]

  @@index([tenantId])
}

model Account {
  id          String        @id @default(uuid()) @db.Uuid
  tenantId    String        @db.Uuid
  memberId    String        @db.Uuid
  type        AccountType
  balance     Decimal       @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id])
  member      Member        @relation(fields: [memberId], references: [id])
  transactions Transaction[]

  @@index([tenantId])
  @@index([tenantId, memberId, type])
}

model Loan {
  id            String           @id @default(uuid()) @db.Uuid
  tenantId      String           @db.Uuid
  borrowerId    String           @db.Uuid
  principal     Decimal
  interestRate  Decimal          // e.g. 0.15 for 15%
  issuedAt      DateTime
  dueDate       DateTime?
  status        String           // "Pending", "Active", "Closed", "Defaulted"
  isTraining    Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  tenant        Tenant           @relation(fields: [tenantId], references: [id])
  borrower      Member           @relation("BorrowerLoans", fields: [borrowerId], references: [id])
  guarantors    LoanGuarantor[]

  @@index([tenantId])
}

model LoanGuarantor {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  loanId     String   @db.Uuid
  memberId   String   @db.Uuid
  guaranteeAmount Decimal

  tenant     Tenant  @relation(fields: [tenantId], references: [id])
  loan       Loan    @relation(fields: [loanId], references: [id])
  member     Member  @relation(fields: [memberId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, loanId, memberId])
}

model Session {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  name           String
  meetingDate    DateTime
  totalCollected Decimal  @default(0)
  cashAtHand     Decimal  @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model ChamaConstitution {
  id             String   @id @default(uuid()) @db.Uuid
  tenantId       String   @db.Uuid
  interestRate   Decimal  // e.g. 0.15 = 15% interest
  lateFineAmount Decimal  // absolute fine amount for late payments
  maxLoanRatio   Decimal  // e.g. 2.0 = 2x contributions
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@unique([tenantId])
}

enum StockTakeStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum StockTakeItemStatus {
  PENDING
  COUNTED
}

enum StockTransferStatus {
  DRAFT
  POSTED
  CANCELLED
}

enum PurchaseOrderStatus {
  DRAFT
  ISSUED
  RECEIVED
  CANCELLED
}

enum GLAccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum ProjectStatus {
  OPEN
  COMPLETED
  CANCELLED
}

enum ProductionOrderStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model StockTake {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  locationId      String   @db.Uuid
  createdByUserId String   @db.Uuid
  status          StockTakeStatus @default(OPEN)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  location   Location @relation(fields: [locationId], references: [id])
  createdBy  User     @relation(fields: [createdByUserId], references: [id])
  items      StockTakeItem[]

  @@index([tenantId])
}

model StockTakeItem {
  id               String   @id @default(uuid()) @db.Uuid
  tenantId         String   @db.Uuid
  stockTakeId      String   @db.Uuid
  productId        String   @db.Uuid
  expectedQuantity Decimal
  countedQuantity  Decimal?
  variance         Decimal?
  status           StockTakeItemStatus @default(PENDING)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  stockTake  StockTake @relation(fields: [stockTakeId], references: [id])
  product    Product   @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@index([tenantId, stockTakeId])
}

model StockTransfer {
  id              String             @id @default(uuid()) @db.Uuid
  tenantId        String             @db.Uuid
  fromLocationId  String             @db.Uuid
  toLocationId    String             @db.Uuid
  status          StockTransferStatus @default(DRAFT)
  createdByUserId String?            @db.Uuid
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  from       Location @relation("FromLocation", fields: [fromLocationId], references: [id])
  to         Location @relation("ToLocation", fields: [toLocationId], references: [id])
  createdBy  User?    @relation(fields: [createdByUserId], references: [id])
  items      StockTransferItem[]

  @@index([tenantId])
}

model StockTransferItem {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @db.Uuid
  stockTransferId String        @db.Uuid
  productId       String        @db.Uuid
  uomId           String        @db.Uuid
  quantity        Decimal

  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  stockTransfer   StockTransfer @relation(fields: [stockTransferId], references: [id])
  product         Product       @relation(fields: [productId], references: [id])
  uom             UnitOfMeasure @relation(fields: [uomId], references: [id])

  @@index([tenantId])
  @@index([tenantId, stockTransferId])
}

model Supplier {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  name      String
  phone     String?
  email     String?
  kraPin    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant           Tenant           @relation(fields: [tenantId], references: [id])
  purchaseOrders   PurchaseOrder[]
  supplierInvoices SupplierInvoice[]

  @@index([tenantId])
}

model Vehicle {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @db.Uuid
  registration    String
  type            String?
  driverName      String?
  driverPhone     String?
  nextServiceDate DateTime?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  trips           Trip[]

  @@index([tenantId])
  @@unique([tenantId, registration])
}

enum TripStatus {
  PLANNED
  LOADING
  DISPATCHED
  DELIVERED
  RETURNED
}

model Trip {
  id          String      @id @default(uuid()) @db.Uuid
  tenantId    String      @db.Uuid
  vehicleId   String      @db.Uuid
  code        String
  status      TripStatus  @default(PLANNED)
  plannedDate DateTime
  dispatchedAt DateTime?
  deliveredAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  vehicle     Vehicle     @relation(fields: [vehicleId], references: [id])
  gatePasses  GatePass[]

  @@index([tenantId])
  @@unique([tenantId, code])
}

enum GatePassStatus {
  DRAFT
  ISSUED
  SCANNED_OUT
  RETURNED
}

model GatePass {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @db.Uuid
  tripId          String         @db.Uuid
  fromLocationId  String         @db.Uuid
  toLocationId    String         @db.Uuid
  status          GatePassStatus @default(DRAFT)
  code            String
  createdAt       DateTime       @default(now())
  issuedAt        DateTime?
  scannedOutAt    DateTime?
  returnedAt      DateTime?

  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  trip            Trip           @relation(fields: [tripId], references: [id])
  fromLocation    Location       @relation("GateFromLocation", fields: [fromLocationId], references: [id])
  toLocation      Location       @relation("GateToLocation", fields: [toLocationId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, code])
}

model TaxQueueEntry {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  invoiceId  String   @db.Uuid
  status     String   // PENDING, SENT, FAILED
  lastError  String?
  attempts   Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
  @@unique([tenantId, invoiceId])
}

model Project {
  id        String        @id @default(uuid()) @db.Uuid
  tenantId  String        @db.Uuid
  name      String
  code      String
  status    ProjectStatus @default(OPEN)
  startDate DateTime
  endDate   DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  invoices       Invoice[]
  purchaseOrders PurchaseOrder[]

  @@index([tenantId])
  @@unique([tenantId, code])
}

model PurchaseOrder {
  id             String              @id @default(uuid()) @db.Uuid
  tenantId       String              @db.Uuid
  supplierId     String              @db.Uuid
  projectId      String?             @db.Uuid
  status         PurchaseOrderStatus @default(DRAFT)
  orderDate      DateTime
  expectedDate   DateTime?
  totalAmount    Decimal             @default(0)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  tenant         Tenant              @relation(fields: [tenantId], references: [id])
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  project        Project?            @relation(fields: [projectId], references: [id])
  items          PurchaseOrderItem[]
  glJournalEntries GLJournalEntry[]

  @@index([tenantId])
  @@index([tenantId, status])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid()) @db.Uuid
  tenantId        String        @db.Uuid
  purchaseOrderId String        @db.Uuid
  productId       String        @db.Uuid
  quantity        Decimal
  unitCost        Decimal
  uomId           String        @db.Uuid
  lineTotal       Decimal       @default(0)

  tenant          Tenant        @relation(fields: [tenantId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  product         Product       @relation(fields: [productId], references: [id])
  uom             UnitOfMeasure @relation(fields: [uomId], references: [id])

  @@index([tenantId])
  @@index([tenantId, purchaseOrderId])
}

model SupplierInvoice {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @db.Uuid
  supplierId   String   @db.Uuid
  invoiceNo    String
  status       String   // "Draft", "Posted", "Partial", "Paid"
  invoiceDate  DateTime
  dueDate      DateTime?
  totalAmount  Decimal  @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  supplier     Supplier @relation(fields: [supplierId], references: [id])
  items        SupplierInvoiceItem[]
  transactions Transaction[]

  @@index([tenantId])
  @@unique([tenantId, invoiceNo])
}

model SupplierInvoiceItem {
  id                String        @id @default(uuid()) @db.Uuid
  tenantId          String        @db.Uuid
  supplierInvoiceId String        @db.Uuid
  productId         String?       @db.Uuid
  quantity          Decimal
  unitCost          Decimal
  uomId             String?       @db.Uuid
  lineTotal         Decimal       @default(0)
  taxRate           TaxRate?

  tenant            Tenant        @relation(fields: [tenantId], references: [id])
  supplierInvoice   SupplierInvoice @relation(fields: [supplierInvoiceId], references: [id])
  product           Product?      @relation(fields: [productId], references: [id])
  uom               UnitOfMeasure? @relation(fields: [uomId], references: [id])

  @@index([tenantId])
  @@index([tenantId, supplierInvoiceId])
}

model GLAccount {
  id        String        @id @default(uuid()) @db.Uuid
  tenantId  String        @db.Uuid
  code      String
  name      String
  type      GLAccountType
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  tenant    Tenant        @relation(fields: [tenantId], references: [id])
  lines     GLJournalLine[]

  @@index([tenantId])
  @@unique([tenantId, code])
}

model GLJournalEntry {
  id               String        @id @default(uuid()) @db.Uuid
  tenantId         String        @db.Uuid
  date             DateTime
  description      String
  invoiceId        String?       @db.Uuid
  purchaseOrderId  String?       @db.Uuid
  createdAt        DateTime      @default(now())

  tenant           Tenant        @relation(fields: [tenantId], references: [id])
  invoice          Invoice?      @relation(fields: [invoiceId], references: [id])
  purchaseOrder    PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  lines            GLJournalLine[]

  @@index([tenantId])
  @@index([tenantId, invoiceId])
  @@index([tenantId, purchaseOrderId])
}

model GLJournalLine {
  id             String         @id @default(uuid()) @db.Uuid
  tenantId       String         @db.Uuid
  journalEntryId String         @db.Uuid
  accountId      String         @db.Uuid
  debit          Decimal        @default(0)
  credit         Decimal        @default(0)

  tenant         Tenant         @relation(fields: [tenantId], references: [id])
  journalEntry   GLJournalEntry @relation(fields: [journalEntryId], references: [id])
  account        GLAccount      @relation(fields: [accountId], references: [id])

  @@index([tenantId])
  @@index([tenantId, journalEntryId])
}

// Fixed Asset registry entry. Depreciation is posted via GLJournalEntry.
model Asset {
  id                    String   @id @default(uuid()) @db.Uuid
  tenantId              String   @db.Uuid
  name                  String
  purchaseDate          DateTime
  purchaseCost          Decimal
  lifespanYears         Int
  salvageValue          Decimal   @default(0)
  accumulatedDepreciation Decimal @default(0)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant                Tenant    @relation(fields: [tenantId], references: [id])
  depreciationRuns      DepreciationRun[]

  @@index([tenantId])
}

// Tracks when depreciation was last run for a tenant/month.
model DepreciationRun {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  period    String   // e.g. "2024-09"
  runAt     DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, period])
}

model BillOfMaterial {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  productId   String   @db.Uuid
  name        String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  product     Product  @relation(fields: [productId], references: [id])
  items       BillOfMaterialItem[]
  productionOrders ProductionOrder[]

  @@index([tenantId])
  @@unique([tenantId, productId])
}

model BillOfMaterialItem {
  id                 String        @id @default(uuid()) @db.Uuid
  tenantId           String        @db.Uuid
  bomId              String        @db.Uuid
  componentProductId String        @db.Uuid
  uomId              String        @db.Uuid
  quantity           Decimal

  tenant             Tenant        @relation(fields: [tenantId], references: [id])
  bom                BillOfMaterial @relation(fields: [bomId], references: [id])
  componentProduct   Product       @relation(fields: [componentProductId], references: [id])
  uom                UnitOfMeasure @relation(fields: [uomId], references: [id])

  @@index([tenantId])
  @@index([tenantId, bomId])
}

model ProductionOrder {
  id          String               @id @default(uuid()) @db.Uuid
  tenantId    String               @db.Uuid
  bomId       String               @db.Uuid
  productId   String               @db.Uuid
  locationId  String               @db.Uuid
  quantity    Decimal
  status      ProductionOrderStatus @default(PLANNED)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  bom         BillOfMaterial     @relation(fields: [bomId], references: [id])
  product     Product            @relation(fields: [productId], references: [id])
  location    Location           @relation(fields: [locationId], references: [id])

  @@index([tenantId])
  @@index([tenantId, status])
}

model SystemLog {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @db.Uuid
  userId     String?  @db.Uuid
  action     String
  entityType String
  entityId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, action])
}

enum EmployeeRole {
  CASUAL
  PERMANENT
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum ShiftStatus {
  OPEN
  CLOSED
}

model Employee {
  id        String         @id @default(uuid()) @db.Uuid
  tenantId  String         @db.Uuid
  name      String
  phone     String?
  dailyRate Decimal
  role      EmployeeRole
  status    EmployeeStatus @default(ACTIVE)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  tenant    Tenant         @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model PasswordResetToken {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  userId    String   @db.Uuid
  token     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  user      User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
}

model IdempotencyKey {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String?  @db.Uuid
  key         String
  method      String
  path        String
  requestHash String?
  response    Json?
  statusCode  Int?
  createdAt   DateTime @default(now())
  expiresAt   DateTime?

  tenant      Tenant?  @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@unique([key, tenantId])
}

model PriceList {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  code      String
  name      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  items     PriceListItem[]
  customers Customer[]

  @@index([tenantId])
  @@unique([tenantId, code])
}

model PriceListItem {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @db.Uuid
  priceListId String   @db.Uuid
  productId   String   @db.Uuid
  unitPrice   Decimal

  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  priceList   PriceList @relation(fields: [priceListId], references: [id])
  product     Product   @relation(fields: [productId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, priceListId, productId])
}

model Coupon {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @db.Uuid
  code          String
  description   String?
  percentageOff Decimal? // 0.0â€“1.0
  amountOff     Decimal?
  active        Boolean  @default(true)
  validFrom     DateTime?
  validTo       DateTime?
  maxUses       Int?
  usedCount     Int      @default(0)
  minSubtotal   Decimal? @default(0)

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  redemptions   CouponRedemption[]

  @@index([tenantId])
  @@unique([tenantId, code])
}

model CouponRedemption {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @db.Uuid
  couponId  String   @db.Uuid
  invoiceId String   @db.Uuid
  discount  Decimal
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  coupon    Coupon   @relation(fields: [couponId], references: [id])
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@unique([tenantId, invoiceId])
}

model Shift {
  id                   String      @id @default(uuid()) @db.Uuid
  tenantId             String      @db.Uuid
  userId               String      @db.Uuid
  status               ShiftStatus @default(OPEN)
  openedAt             DateTime    @default(now())
  closedAt             DateTime?
  openingFloat         Decimal     @default(0)
  closingFloat         Decimal?
  expectedClosingCash  Decimal?    @default(0)
  variance             Decimal?    @default(0)
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  tenant               Tenant      @relation(fields: [tenantId], references: [id])
  user                 User        @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([tenantId, userId, status])
}